---
title: 'A Handbook on R'
author: "Freddy Ray Drennan"
date: "`r Sys.Date()`"
output: pdf_document
documentclass: book
bibliography:
- book.bib
- packages.bib
biblio-style: apalike
link-citations: yes
description: A labor of love about R
site: bookdown::bookdown_site
---

# Introduction

## R is a Functional Language

A function does stuff given a set of inputs. Remember seeing equations like $y = 2x + 3$ in algebra? We said given $x=2$ then $y=7$. because $2(2) + 3 = 7$. In calculus, equations became functions with a slightly different syntax. $f(x) = 2x + 3$. What happened to the $y$? Well, nothing really. We can say $y=f(x)=x^2$ or $result=f(x)$ or $z=g(x,y)=x + min(x, y)$. Once we have these definitions, we can go further and compose them together. For example, $f(g(x, y)) = (x + min(x, y))^2$. Now, the outputs of functions become the inputs for other functions.

```{r}
library(cli)

# Same as f(x) = 2x + 3
f <-  function(x) {
  x <- x * x
  x
}

g <- function(x=NULL, y=NULL) {
  result <- x + min(x, y)
  result
}

print(f(g(3, 4)))
```

We now have a way of describing inputs and output a little more clearly. Instead of writing, $(3 + min(3, 4)) * (3 + min(3, 4))$ we can write $f(g(3, 4))$ or try new creations like $z(x, y)=f(g(f(x), f(y)))$ so $z(1, 2)=f(g(f(1), f(2)))=f(g(1, 4))=f(2)=4$.\
\
Now just take this idea about functions and expand your definition of inputs and outputs to be any number, none or many, and of any type that R supports - character, numeric, date/time, data.frame or list - all of which we'll cover.

## Solve a Problem in R

Let's solve a problem using R. Suppose we have a friend that is interested in the current trend regarding COVID-19 cases. The first thing we will probably do is try to figure out an efficient and reliable way for importing Covid-19 data into our R session. Conveniently, the [`COVID19`](https://covid19datahub.io/articles/r.html) package allows us to pull the latest data without any hard work and consists of one function - `covid19`.

### Installing Packages

In your RStudio console, you can write the following to install the `COVID19` package using the `install.packages` function. If you are interested in learning more about this function, you can write `?install.packages` in your console and the documentation for the function will appear.

```{r, eval=FALSE}
# For help menu, uncomment next line
# ?install.packages 

# If the package is not yet installed, you can install it by passing 
# a string with the package name to the `install.packages` function
install.packages(pkgs = c('COVID19'))
```

### Available Packages on CRAN

\
For a full list of what packages are available through the `install.packages` function, please check out the [Contributed Packages](https://cran.r-project.org/web/packages/index.html) page at CRAN or scrape it yourself.\

```{r}
library(rvest)
cran_packages <- 'https://cran.r-project.org/web/packages/available_packages_by_date.html'
package_data <- html_table(html_element(read_html(cran_packages), 'table'))
print(package_data)
n_packages <- length(unique(package_data$Package))
cli_alert_info('There are {n_packages} packages on CRAN')
```

## Using Functions to Solve a Problem

\
The code below consists of three different functions. The first two are `library` and `covid19`, but the third is hidden - it's actually the arrow, `<-` if you execute `` `<-`(a, 1) `` the output of the function actually creates the variable `a` within your session! *Functions* are spaces for stuff to happen. Functions help us make common procedures repeatable. By creating a function with a particular name and inputs, we can get some sort of useful (or not useful, the world's your oyster) output.

In this case, `library` loads packages from a folder in the R environment called library. You can see which ones your R environment knows about by running the function `.libPaths()`. The dot in front of `.libPaths()` just means that the author intended it to be hidden, which doesn't really mean much to us. When you run `install.packages` that code is at a path in the `.libPaths()` output.

`covid19` is a function from the `COVID19` package, and would only be available after executing `library(COVID19)` or if `library(COVID19)` is omitted, by pulling it from the package namespace directly by preceding the function with the package name and two colons like so: `COVID19::covid19`. Generally speaking, you simply use `library` because it reduces the amount of text on the page.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(COVID19)
covid_data <- covid19(
    country = 'United States', 
    start = '2021-01-01', 
    end = "2021-11-21",
    verbose = FALSE, 
    level = 2
)
covid_data
```

Let's look at what happened - we passed a few inputs and received a dataframe. A dataframe is a list with the requirement that all elements of the list are atomic vectors of equal length. Let's look at what that means.

```{r}
iwalk(
  covid_data,
  function(item, idx_nm) {
    length_item <- length(item)
    item_type <- typeof(item)
    cli_alert('{idx_nm} is a {item_type} with length {length_item}')
    print(unique(item)[1:3])
  }
)
```

When you have a list of things, you can apply a function to each item in the list. So in the list above, we have 47 atomic vectors. What does that mean? An atomic vector is like a list, but it has to contain the same thing in each cell.

[How do I know if a function is vectorized](https://stackoverflow.com/questions/58568392/how-do-i-know-a-function-or-an-operation-in-r-is-vectorized#:~:text=To%20identify%20if%20an%20R%20object%20is%20a%20vector%20%2C%20I,a%20vector%20or%20False%20otherwise.)\
[Vectorization in R](￼￼https://www.noamross.net/archives/2014-04-16-vectorization-in-r-why/)

```{r}
vector_example <- c(1, 'a', TRUE)
list_example <- list(1, 'a', TRUE)

map_chr(vector_example, typeof)
map_chr(list_example, typeof)
```

With the knowledge of vectors and lists, what can we do? Well, the first thing I notice is that some of the vectors are completely `NA`. Let's check the number of NA values in each vector.

```{r}
all_na <- function(item) {
  sum(is.na(item))==length(item) 
}
covid_data <- discard(covid_data, all_na)
covid_data
```

## Initial Setup

[Book Outline](https://hackmd.io/vGRGEPo8QQyiG8gecWv71g)

-   [Install R](https://cran.r-project.org/)

-   [Install R Studio](https://www.rstudio.com/products/rstudio/download/)

-   [Windows Only: Install RTools](https://cran.r-project.org/bin/windows/Rtools/)

    -   When installed, run in the RStudio Console: `write('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', file = "~/.Renviron", append = TRUE)`

-   [Windows Only: Install WSL2](https://www.omgubuntu.co.uk/how-to-install-wsl2-on-windows-10)

    -   Computer should be completely updated before install.

-   [Install Git](https://git-scm.com/downloads)

-   [Create Github Account](https://github.com/)

-   [Fork r-handbook](https://github.com/fdrennan/r-handbook)

-   [Install Docker and Docker Compose](https://docs.docker.com/get-docker/)

-   [Create AWS Account](https://aws.amazon.com/)

    -   Billing will be discussed in the course, but don't expect to pay much - i.e., 10-20 dollars a month for high course activity.
    -   Remember to `stop` EC2 servers when we begin using them. AWS is polite about your first few refund requests.

-   [Create Reddit Account](reddit.com)

    -   [Follow Instructions here](https://towardsdatascience.com/how-to-use-the-reddit-api-in-python-5e05ddfd1e5c)

Make sure you install the [`tidyverse`](https://www.tidyverse.org/) packages. Update to renv later.

```{r eval=FALSE}
install.packages('tidyverse')
```

<!--chapter:end:index.Rmd-->

# What is R

## Types of Problems You Can Solve

## Base R, Tidyverse, data.table

## Arguments/ Developments within the language

## What are Variables

### Valid Variable Names



```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```

<!--chapter:end:02-what-is-R.Rmd-->

# Building Blocks {#functions}

## Vectors

Vectors are containers information of similar type. You can think of them as having $1*n$ cells where $n$ is any positive integer, and make up the rows and columns of tables. Vectors always contain the same type of value. R has many different types of vectors, but the most common are **numeric**, **character**, and **logical** (**TRUE**/**FALSE**).

Vectors are cool. I like to think of them as boxes that can only be stacked on top of one another.

```{r}
typeof(c(TRUE))
typeof(c(TRUE, 1))
typeof(c(TRUE, 1, 'a'))
```

## Functions

**Functions** are containers where anything or nothing can happen, but whatever happens, it happens the same way every single time. They allow for generalization of complicated ideas and routines that we wish to repeat over and over again. A function may have an input, but no output. It may have an output, but no input, both or none. If it's something you need to do repeatedly, or containing code makes your program easier to read, then write a function for that process.

**Rule 4: Functions have inputs, outputs, and a body.** A function can have multiple outputs, but given a particular set of inputs, the solution should never change assuming you are not developing a function with randomness built in.

R has a built-in [constant](https://stat.ethz.ch/R-manual/R-devel/library/base/html/Constants.html) called `letters`. This means that no matter where you are writing R, `letters` will be available to you. We see that `letters` is a **character** **vector** in our program below, and use the composition of functions to create a program that describes `letters`.

```{r}
print(letters)
```

Next, we can use some functions which take in pretty much any object that exists in R and spits back information regarding the `letters` data.

```{r}
main <- function() {
  print_information <- function(x) {
    
    variable_name = deparse1(substitute(x))
    
    length_x = length(x)
    typeof_x <- typeof(x)
    is_vec_x <- is.vector(x)
    
    meta_list <- list(
      length = length_x, 
      type = typeof_x, 
      is_vector = is_vec_x
    )
    
    cli::cli_alert('Information about {variable_name}')
    
    cli::cli_alert_info("{variable_name} is a 1x{length_x} dimensional")
    cli::cli_alert_info("")
    
    purrr::iwalk(meta_list, function(x, index) {
      cli::cli_alert_info(glue::glue('{index} {x} is type {typeof(x)}'))
    })
    
    return(meta_list)
  }
  
  cli::cli_alert_info('Execute print_information')
  output <- print_information(mtcars)
  cli::cli_alert_success('Execute print_information complete')
  
  print(output)
}

main()
```

<!--chapter:end:03-building-blocks.Rmd-->

# Debugging

## What is the debugger?
## How to learn R without knowing any R
## `browser()`
## `next`, `continue`
## `debug` and `undebug`
## `debugonce`
## Understanding debugging output
## LOTS OF DEBUGGING EXERCISES CANNOT STRESS ENOUGH

<!--chapter:end:04-debugging.Rmd-->

# Vectors 

## `c`
## `[` and `[[`

* Vectors
  * atomic
* Strings
  * Base R
  * `stringr`
      * Regular Expressions
  * [Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/strings.pdf)
* Numbers
  * Integer
  * Double
* Factors
  * `as.factor` vs. `as_factor`
* Dates
  * Base R
  * `lubridate`  

<!--chapter:end:05-vectors.Rmd-->

# Lists

## `list`
## `[` and `[[`

* Lists
  * `list()` and `c`
  * `[` and `[[`
  * Connection between lists and json
    * `jsonlite`

<!--chapter:end:06-lists.Rmd-->

# Tables

## `c`
## `[` and `[[`

* Tables
  * matrices
  * `data.frame` vs `tibble`
  * data.frames are lists with equal length, atomic vectors

<!--chapter:end:07-tables.Rmd-->

# Functional Programming

2. [Functions](https://hackmd.io/R_cVl-DBSve03vc1trHrGw)
    * Sequences
    * Mapping functions
    * pipes
    * void
    * `return`
        * Can a function return nothing?
        * What are side effects?
        * Multiple return statements

## Base R
 `apply`, `lapply`, `mapply`

## Modern R

[`purrr`](https://raw.githubusercontent.com/rstudio/cheatsheets/main/purrr.pdf)
* `map_*`
* `map2_*`
* `pmap_*`
  * Iterate over What?
  * Why are data.frames mapped over columnwise?
    * A: data.frames are lists, and mapping functions will iterate over each individual item in a list

<!--chapter:end:08-functional-programming.Rmd-->

# Tidy Data

* Concept of tidy data
  * [Tidy Data Paper](https://vita.had.co.nz/papers/tidy-data.pdf)
* `tidyr`
  * `pivot_longer`
  * `pivot_wider`

<!--chapter:end:09-tidy-data.Rmd-->

# dplyr

* `dplyr` and data manipulation
  * main functions
    * `select`
    * `mutate`
    * `filter`
    * `transmute`
  * summarizing data
    * `group_by`
    * `summarize` - one row per group
    * `mutate` - one or many rows per group will have same value
    * `ungroup` - remove grouping
        * Not everything has to be a `group_by`
        * Solving group problems with vectors 

<!--chapter:end:10-dplyr.Rmd-->

* Joining Tables 
    * `inner_join`
    * `full_join`
    * `left_join` / `right_join`

<!--chapter:end:11-joins.Rmd-->


# Project Outline

To be expanded over many chapters

1. Windows vs Mac vs Linux
2. Docker Installation
    * Windows needs to set up VM in bios
3. RStudio IDE
    * [Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rstudio-ide.pdf)
4. reddit api creds
5. reticulate
    * Enough R to know Python
        * [Type Conversions](https://rstudio.github.io/reticulate/)
    * miniconda installation
    * virtual environments
6. Package Structure
    * Defaults for RStudio
        * Rebuild and Restart with Roxygen2
    * `.env`
    * `.gitignore`
    * `.Rprofile`
    * `.Renviron`
    * Packages necessary for efficient development
        * usethis
        * roxygen
        * devtools
            * [Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/package-development.pdf)
    * Make and Makefiles
        * Automating Package Build
    * Unit Testing (probably bad location for ut, no code written)
        * testthat
7. Git
    * Github
    * git circle, workflow 
9. Retrieving Data from API
    * `praw`
    * `dotenv` and `.env`
    * [Old Reddit Code to start with](https://github.com/fdrennan/ndexr-platform/blob/master/redditor-api/R/reddit.R)
10. Docker and Docker Compose Introduction
    * `.dockerignore`
11. Create Postgres Database
    * What are Ports?
    * Postgres Credentials
12. Create functions for Storing Reddit Data
13. *Need preferred method for streaming data, i.e., Airflow not a good scheduler for scripts that are always running* and need a kickstart on failure, timeout, etc. Docker with `restart: always` may be sufficient
14. Plumber API
    * Add to docker-compose
    * Functions for ETL, Shiny Application
15. ETL with Airflow and HTTP operator connected to Plumber API
16. Shiny
    * Reactive Graph
        * Order does not matter, the graph does
    * Why Modules?
        * `map` over modules
17. Automating Infrastructure
    * `awscli`
    * `boto3`
        * [`biggr`](https://github.com/fdrennan/ndexr-platform/tree/master/biggr/R)
    * Create EC2 Server from R
        * User Data

<!--chapter:end:12-aws-project-outline.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:13-references.Rmd-->

